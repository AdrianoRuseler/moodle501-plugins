name: Build Plugins-Only Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Plugins
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0 # Fetch all tags to calculate the daily counter correctly

      - name: Generate Daily Version String
        id: vars
        run: |
          DATE=$(date +'%Y%m%d')
          
          # Count how many tags exist starting with today's date
          # This looks for tags like 20260211.01, 20260211.02...
          COUNT=$(git tag -l "${DATE}.*" | wc -l)
          
          # Increment the count for the new release
          NEXT_NUM=$((COUNT + 1))
          
          # Format to 2 digits (e.g., 01, 02)
          VERSION="${DATE}.$(printf "%02d" $NEXT_NUM)"
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated Daily Version: $VERSION"

      - name: Create Archive
        run: |
          # Create a compressed tarball using XZ
          # -c: create, -J: xz compression, -f: filename
          tar -cJf plugins-dist.tar.xz moodle/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: plugins-dist.zip 
          tag_name: ${{ steps.vars.outputs.VERSION }}
          name: ${{ steps.vars.outputs.VERSION }}
          # The body now includes a dynamic link to the release.md file at the current commit
          body: |
            ### ðŸ“¦ Release Details
            - **Version:** `${{ steps.vars.outputs.VERSION }}`
            - **Build Date:** $(date +'%Y-%m-%d')
            - **Full Changelog:** [View release.md](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/release.md)
          draft: false
          prerelease: false

      - name: Delete Older Releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        
